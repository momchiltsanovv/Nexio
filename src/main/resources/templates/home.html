<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Items - Nexio</title>
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <th:block th:replace="fragments/background :: background-styles"></th:block>
</head>
<body>
<th:block th:replace="fragments/background :: background-elements"></th:block>

<div th:replace="fragments/navbar :: navbar(${active})"></div>

<!-- Main Content -->
<main class="main-content">
    <!-- Content Layout -->
    <div class="content-layout">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container-main">
                <h2>Find what you're looking for</h2>
                <p>Discover amazing items from your university community</p>
                <div class="search-bar-main">
                    <i class="fas fa-search search-icon-main"></i>
                    <input type="text" id="mainSearchInput" placeholder="Search for items, books, electronics...">
                    <button class="search-btn-main" id="mainSearchBtn">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                </div>
            </div>
        </div>
        <!-- Filters Sidebar -->
        <aside class="filters-sidebar" id="filtersSidebar">
            <div class="filters-header">
                <h3>
                    <i class="fas fa-filter"></i>
                    Filters
                </h3>
                <button class="clear-filters" id="clearFilters">Clear All</button>
            </div>

            <!-- Category Filter -->
            <div class="filter-section">
                <h4>Category</h4>
                <div class="filter-buttons" id="categoryFilterButtons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="TEXTBOOKS">
                        <i class="fas fa-book"></i>
                        Textbooks
                        <span class="count" th:text="${textbooksCount}">(45)</span>
                    </button>
                    <button class="filter-btn" data-filter="ELECTRONICS">
                        <i class="fas fa-laptop"></i>
                        Electronics
                        <span class="count" th:text="${electronicsCount}">(32)</span>
                    </button>
                    <button class="filter-btn" data-filter="FURNITURE">
                        <i class="fas fa-chair"></i>
                        Furniture
                        <span class="count" th:text="${furnitureCount}" >(18)</span>
                    </button>
                    <button class="filter-btn" data-filter="CLOTHING">
                        <i class="fas fa-tshirt"></i>
                        Clothing
                        <span class="count" th:text="${clothingCount}">(27)</span>
                    </button>
                    <button class="filter-btn" data-filter="SPORTS">
                        <i class="fas fa-dumbbell"></i>
                        Sports
                        <span class="count" th:text="${sportsCount}">(15)</span>
                    </button>
                    <button class="filter-btn" data-filter="ACCESSORIES">
                        <i class="fas fa-gem"></i>
                        Accessories
                        <span class="count" th:text="${accessoriesCount}">(12)</span>
                    </button>
                    <button class="filter-btn" data-filter="SERVICES">
                        <i class="fas fa-handshake"></i>
                        Services
                        <span class="count" th:text="${servicesCount}">(8)</span>
                    </button>
                </div>
            </div>

            <!-- Price Filter -->
            <div class="filter-section">
                <h4>Price Range</h4>
                <div class="price-range">
                    <div class="price-inputs">
                        <input type="number" id="minPrice" placeholder="Min" min="0">
                        <span>-</span>
                        <input type="number" id="maxPrice" placeholder="Max" min="0">
                        <span>лв</span>
                    </div>
                </div>
            </div>

            <!-- Condition Filter (matches ItemCondition enum) -->
            <div class="filter-section">
                <h4>Condition</h4>
                <div class="filter-buttons" id="conditionFilterButtons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="NEW">
                        <i class="fas fa-star"></i>
                        New
                    </button>
                    <button class="filter-btn" data-filter="LIKE_NEW">
                        <i class="fas fa-star-half-alt"></i>
                        Like New
                    </button>
                    <button class="filter-btn" data-filter="GOOD">
                        <i class="fas fa-thumbs-up"></i>
                        Good
                    </button>
                    <button class="filter-btn" data-filter="FAIR">
                        <i class="fas fa-minus-circle"></i>
                        Fair
                    </button>
                    <button class="filter-btn" data-filter="POOR">
                        <i class="fas fa-exclamation-circle"></i>
                        Poor
                    </button>
                    <button class="filter-btn" data-filter="REFURBISHED">
                        <i class="fas fa-tools"></i>
                        Refurbished
                    </button>
                </div>
            </div>


            <!-- Location Filter -->
            <div class="filter-section">
                <h4>Location</h4>
                <select id="locationFilter" class="location-select">
                    <option value="all">All Locations</option>
                    <option value="CAMPUS">Campus</option>
                    <option value="NEARBY">Nearby</option>
                    <option value="SHIPPING">Shipping</option>
                </select>
            </div>
        </aside>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Header with sorting and view options -->
            <div class="content-header">
                <div class="results-info">
                    <h2>Browse Items</h2>
                    <p class="results-count">Showing <span id="resultsCount">157</span> items</p>
                </div>

                <div class="header-controls">
                    <div class="sort-options">
                        <label for="sortSelect">Sort by:</label>
                        <select id="sortSelect">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="popular">Most Popular</option>
                        </select>
                    </div>




                </div>
            </div>

            <!-- Active Filters -->
            <div class="active-filters" id="activeFilters">
                <!-- Active filters will be dynamically inserted here -->
            </div>

            <!-- Items Grid -->
            <div class="items-grid">
                <!-- Items populated by Thymeleaf -->
                <div class="item-card"
                     th:each="item : ${items}"
                     th:data-category="${item.category != null ? item.category : ''}"
                     th:data-price="${item.price}"
                     th:data-condition="${item.condition != null ? item.condition : ''}"
                     th:data-id="${item.id}"
                     th:data-title="${item.name}"
                     th:data-description="${item.description}"
                     th:data-location="${item.exchangeLocation.name()}"
                     th:data-imageurl="${item.imageURLs != null and !item.imageURLs.isEmpty() ? item.imageURLs[0] : '/images/defaults/no_image.webp'}"
                     th:data-seller-name="${item.owner.firstName + ' ' + item.owner.lastName}"
                     th:data-seller-uni="${item.owner.university}"
                     th:data-seller-avatar="${item.owner.profilePictureURL != null ? item.owner.profilePictureURL : '/images/defaults/default_pfp.jpg'}"
                     th:data-createdat="${item.createdOn}">

                    <div class="item-image">
                        <img th:src="@{${item.imageURLs != null and !item.imageURLs.isEmpty() ? item.imageURLs[0] : '/images/defaults/no_image.webp'}}"
                             th:alt="${item.name ?: 'Item image'}"
                             onerror="this.src='/images/defaults/no_image.webp'">
                        <div class="item-badges">
                                <span class="condition-badge"
                                      th:classappend="${item.condition != null ? #strings.toLowerCase(item.condition.getDisplayName()).replace(' ', '-') : ''}"
                                      th:text="${item.condition.getDisplayName()}">Good</span>
                        </div>
                    </div>

                    <div class="item-content">
                        <div class="item-category" th:if="${item.category != null}">
                            <span th:text="${item.category != null ? #strings.capitalize(item.category.toString().toLowerCase()) : 'Other'}">Category</span>
                        </div>


                        <h3 class="item-title" th:text="${item.name ?: 'Untitled Item'}">Item Title</h3>

                        <p class="item-description" th:text="${item.description ?: 'No description available'}">Item description</p>

                        <div class="item-details">
                            <div class="item-price" th:text="${item.price != null ? item.price + ' лв' : 'Price not set'}">0 лв</div>
                            <div class="item-location" th:if="${item.exchangeLocation != null}">
                                <i class="fas fa-map-marker-alt"></i>
                                <span th:text="${item.exchangeLocation != null ? item.exchangeLocation.displayName : 'Location not set'}">Location</span>
                            </div>
                        </div>

                        <div class="item-actions">
                            <a th:href="@{'/items/' + ${item.id}}" class="btn btn-primary">
                                <i class="fas fa-eye"></i>
                                View Details
                            </a>
                        </div>
                    </div>
                </div>

                    <!-- Empty state when no items -->
                    <div th:if="${items == null or items.isEmpty()}" class="empty-state">
                        <div class="empty-content">
                            <i class="fas fa-box-open"></i>
                            <h3>No items found</h3>
                            <p>There are currently no items available.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End content-layout -->
</main>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemGrid = document.querySelector('.items-grid');
        const itemCards = itemGrid.querySelectorAll('.item-card');
        const resultsCountSpan = document.getElementById('resultsCount');

        const mainSearchInput = document.getElementById('mainSearchInput');
        const mainSearchBtn = document.getElementById('mainSearchBtn');

        const categoryFilterButtons = document.querySelectorAll('#categoryFilterButtons .filter-btn');
        const conditionFilterButtons = document.querySelectorAll('#conditionFilterButtons .filter-btn');
        const minPriceInput = document.getElementById('minPrice');
        const maxPriceInput = document.getElementById('maxPrice');
        const locationFilter = document.getElementById('locationFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const sortSelect = document.getElementById('sortSelect');

        let activeCategoryFilter = 'all';
        let activeConditionFilter = 'all';
        let currentSearchTerm = '';
        let currentSortOrder = 'newest';

        // Initial setup for search input
        mainSearchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                applyFiltersAndSort();
            }
        });

        mainSearchBtn.addEventListener('click', applyFiltersAndSort);

        // Category filter event listeners
        categoryFilterButtons.forEach(button => {
            button.addEventListener('click', function() {
                categoryFilterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeCategoryFilter = this.dataset.filter;
                applyFiltersAndSort();
            });
        });

        // Condition filter event listeners
        conditionFilterButtons.forEach(button => {
            button.addEventListener('click', function() {
                conditionFilterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeConditionFilter = this.dataset.filter;
                applyFiltersAndSort();
            });
        });

        // Price filter event listeners
        minPriceInput.addEventListener('input', applyFiltersAndSort);
        maxPriceInput.addEventListener('input', applyFiltersAndSort);

        // Location filter event listener
        locationFilter.addEventListener('change', applyFiltersAndSort);

        // Sort select event listener
        sortSelect.addEventListener('change', function() {
            currentSortOrder = this.value;
            applyFiltersAndSort();
        });

        // Clear filters event listener
        clearFiltersBtn.addEventListener('click', function() {
            mainSearchInput.value = '';
            minPriceInput.value = '';
            maxPriceInput.value = '';
            locationFilter.value = 'all';
            sortSelect.value = 'newest';

            categoryFilterButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('#categoryFilterButtons .filter-btn[data-filter="all"]').classList.add('active');
            activeCategoryFilter = 'all';

            conditionFilterButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('#conditionFilterButtons .filter-btn[data-filter="all"]').classList.add('active');
            activeConditionFilter = 'all';

            applyFiltersAndSort();
        });


        function applyFiltersAndSort() {
            currentSearchTerm = mainSearchInput.value.toLowerCase();
            const minPrice = parseFloat(minPriceInput.value) || 0;
            const maxPrice = parseFloat(maxPriceInput.value) || Infinity;
            const selectedLocation = locationFilter.value;

            let visibleItems = [];

            itemCards.forEach(card => {
                const category = card.dataset.category;
                const condition = card.dataset.condition;
                const price = parseFloat(card.dataset.price);
                const location = card.dataset.location;
                const title = card.dataset.title.toLowerCase();
                const description = card.dataset.description.toLowerCase();

                let showCard = true;

                // Category filter
                if (activeCategoryFilter !== 'all' && category !== activeCategoryFilter) {
                    showCard = false;
                }

                // Condition filter
                if (activeConditionFilter !== 'all' && condition !== activeConditionFilter) {
                    showCard = false;
                }

                // Price filter
                if (price < minPrice || price > maxPrice) {
                    showCard = false;
                }

                // Location filter
                if (selectedLocation !== 'all' && location !== selectedLocation) {
                    showCard = false;
                }

                // Search filter
                if (currentSearchTerm && !title.includes(currentSearchTerm) && !description.includes(currentSearchTerm)) {
                    showCard = false;
                }

                if (showCard) {
                    card.style.display = '';
                    visibleItems.push(card);
                } else {
                    card.style.display = 'none';
                }
            });

            // Sort visible items
            sortItems(visibleItems, currentSortOrder);

            // Update results count
            resultsCountSpan.textContent = visibleItems.length;

            // Show/hide empty state message
            const emptyState = document.querySelector('.empty-state');
            if (visibleItems.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        }

        function sortItems(items, order) {
            items.sort((a, b) => {
                const priceA = parseFloat(a.dataset.price);
                const priceB = parseFloat(b.dataset.price);
                const dateA = new Date(a.dataset.createdat);
                const dateB = new Date(b.dataset.createdat);

                switch (order) {
                    case 'newest':
                        return dateB - dateA;
                    case 'oldest':
                        return dateA - dateB;
                    case 'price-low':
                        return priceA - priceB;
                    case 'price-high':
                        return priceB - priceA;
                    case 'popular':
                        // Assuming popularity can be determined by some other data attribute,
                        // for now, we'll just keep the existing order if no popularity data.
                        return 0;
                    default:
                        return 0;
                }
            });

            // Re-append sorted items to the grid
            items.forEach(item => itemGrid.appendChild(item));
        }

        // Initial apply of filters and sort on page load to set counts and visibility correctly
        applyFiltersAndSort();

    });
</script>
<div th:replace="fragments/navbar-script :: navbar-script"></div>
</body>
</html>